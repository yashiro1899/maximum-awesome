#!/bin/bash


trap 'exit 0' INT

CONFIG="$HOME/.shadowsocks.json"
INSTANCEID="i-478eede2"
describe() {
    aws ec2 describe-instances --instance-ids $INSTANCEID
}
getip() {
    jq '.Reservations[].Instances[].PublicIpAddress' <<< $1
}
echossh() {
    if [ "$1" == "null" ]; then
        return 1
    fi

    echo -n "ssh"
    echo -n " -o StrictHostKeyChecking=no"
    echo -n " -o UserKnownHostsFile=/dev/null"
    echo " ec2-user@$1"
}

case "$1" in
    start)
        aws ec2 "start-instances" --instance-ids $INSTANCEID | \
            jq '.StartingInstances[].CurrentState.Name'

        publicip="null"
        while [ "$publicip" == "null" ]; do
            sleep 5

            output=$(describe)
            publicip=$(getip "$output")
            jq '.Reservations[].Instances[].State.Name' <<< $output
        done
        sed -i 's/"server": ".\+$/"server": '$publicip',/' "$CONFIG"
        echossh $publicip;;
    stop)
        aws ec2 "stop-instances" --instance-ids $INSTANCEID | \
            jq '.StoppingInstances[].CurrentState.Name';;
    status)
        output=$(describe)
        publicip=$(getip "$output")
        jq '.Reservations[].Instances[].State.Name' <<< $output
        echossh $publicip;;
    *)
        echo "usage: $0 {start|stop|status}"
        exit 2
esac
